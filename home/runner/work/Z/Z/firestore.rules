rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // безопасно получить list или пустой list если поле отсутствует
    function safeList(x) {
      return x is list ? x : [];
    }

    // Проверяет что единственное изменение в likedBy — добавление или удаление текущего uid
    function isLikingOrUnliking() {
      let oldList = safeList(resource.data.likedBy);
      let newList = safeList(request.resource.data.likedBy);

      let oldSet = oldList.toSet();
      let newSet = newList.toSet();

      // что добавили (в new, но не в old)
      let added = newSet.difference(oldSet);
      // что удалили (в old, но не в new)
      let removed = oldSet.difference(newSet);

      // допустимая операция: либо добавили ровно uid, а удалений нет,
      // либо удалили ровно uid, а добавлений нет.
      return (
        added.size() == 1 && added.has(request.auth.uid) && removed.size() == 0
      ) || (
        removed.size() == 1 && removed.has(request.auth.uid) && added.size() == 0
      );
    }

    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    match /posts/{postId} {
      allow read: if true;

      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;

      // DEBUG: Temporarily allow all authenticated updates to isolate the issue.
      allow update: if request.auth != null;
    }
  }
}
